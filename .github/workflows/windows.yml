name: Windows build

on:
  push:
    branches:
      - 'master'
      - 'develop'
    tags:
      - 'v*'
  pull_request:
    branches:
      - 'master'
      - 'develop'

defaults:
  run:
    shell: cmd

env:
  SOURCE_DIR: ${{ github.workspace }}
  QBS_VERSION: 3.0.1
  INNOSETUP_VERSION: 6.4.0
  VALENTINA_VERSION: 1_0_0
  ACCESS_TOKEN: ${{ secrets.DROPBOX_ACCESS_TOKEN }}

jobs:
  build:
    name: Windows Qt ${{ matrix.qt.install }} (MSVC x64)
    runs-on: windows-latest

    strategy:
      matrix:
        qt:
          # LTS release
          - install: 6.8.3
            label: Qt6_8
            run_tests: 'true'
            deploy: 'true'

    env:
      DEPLOY: ${{ matrix.qt.deploy }}
      RUN_TESTS: ${{ matrix.qt.run_tests }}
      WITH_CRASH_REPORTING: 'True'
      INSTALL_QT: ${{ matrix.qt.install }}
      QT_VERSION: ${{ matrix.qt.label }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Fetch tags
        run: git fetch --prune --unshallow --tags

      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          architecture: "x64"
          cache: 'pip'
          cache-dependency-path: 'share/ci/requirements-ci.txt'

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version:      ${{ env.INSTALL_QT }}
          host:         'windows'
          target:       'desktop'
          arch:         win64_msvc2022_64
          dir:          ${{ runner.temp }}
          modules:      'qtimageformats'
          cache:        true
          tools:        'tools_opensslv3_x64'
          setup-python: false

      - name: Setup cmake
        uses: jwlawson/actions-setup-cmake@v2

      - name: Set up Visual Studio shell
        uses: egor-tensin/vs-shell@v2
        with:
          arch: x64

      - name: Install Python dependencies
        run: |
          python --version
          python -m pip install --upgrade setuptools
          python -m pip install -r share/ci/requirements-ci.txt

      - name: Cache Chocolatey
        uses: actions/cache@v4
        with:
          path: C:\Users\runneradmin\AppData\Local\Temp\chocolatey
          # This caches the cache, no need to make sure that this is invalidated
          # chocolatey will do that for us.
          key: chocolatey-cache

      - name: Install Chocolatey dependencies
        run: |
          choco install qbs -y --version=${{ env.QBS_VERSION }}
          choco install innosetup -y --version=${{ env.INNOSETUP_VERSION }}
          qbs --version

      - name: Find cl.exe
        id: cl-path
        shell: pwsh
        run: |
          function Locate-VSWhere {
              $path = Get-Command 'vswhere' -ErrorAction SilentlyContinue
              if ($path) {
                  $path.Path
              } else {
                  Join-Path ${env:ProgramFiles(x86)} 'Microsoft Visual Studio' 'Installer' 'vswhere'
              }
          }

          function Locate-VS {
              # vswhere doesn't search for Build Tools by default, God knows why.
              # https://github.com/microsoft/vswhere/issues/22
              $products = 'Community','Professional','Enterprise','BuildTools' | %{ "Microsoft.VisualStudio.Product.$_" }
              $vswhere = Locate-VSWhere
              & $vswhere -products $products -latest -format json | ConvertFrom-Json
          }

          function Locate-CLPath {
              $vsInfo = Locate-VS
              if ($vsInfo) {
                  $vsInstallPath = $vsInfo[0].installationPath
                  $clPath = Join-Path $vsInstallPath 'VC\Tools\MSVC'
                  $latestVersion = (Get-ChildItem -Path $clPath | Where-Object { $_.PSIsContainer } | Sort-Object -Property Name -Descending)[0].Name
                  $clPath = Join-Path $clPath $latestVersion
                  $clPath = Join-Path $clPath 'bin\Hostx64\x64\cl.exe'
                  return $clPath
              } else {
                  Write-Output "Visual Studio not found."
                  return $null
              }
          }

          $clPath = Locate-CLPath
          echo "Found Cl at $clPath"
          echo "cl-path=$clPath" >> $env:GITHUB_OUTPUT

      - name: Setup path to Conan home folder
        shell: bash
        run: echo "CONAN_HOME=${{ runner.temp }}/.conan2" >> $GITHUB_ENV

      - name: Cache Conan packages (Conan 2.x)
        uses: actions/cache@v4
        with:
          path: ${{ env.CONAN_HOME }}/p
          key: conan2-packages-${{ runner.os }}-v1-${{ hashFiles('**/conanfile.py') }}
          restore-keys: conan2-packages-${{ runner.os }}-

      - name: Before build
        run: |
          git fetch --tags
          qbs-setup-toolchains --detect
          qbs-setup-qt %QT_ROOT_DIR%\bin\qmake.exe qt6
          qbs-config defaultProfile qt6
          qbs-setup-toolchains.exe --type msvc "${{ steps.cl-path.outputs.cl-path }}" msvc
          qbs-config.exe profiles.qt6.baseProfile msvc
          qbs-config --list profiles

      - name: Build Conan dependencies
        shell: bash
        run: conan install . --build=missing -o '&:with_crash_reporting=${{ env.WITH_CRASH_REPORTING }}' -o '&:with_xerces=True' -pr:a=share/ci/conan/profiles/windows

      - name: Set up common Qbs args
        shell: bash
        run: >
          echo "COMMON_QBS_ARGS=
          -f valentina.qbs
          -d \"$RUNNER_TEMP/build\"
          config:release
          qbs.installRoot:\"$RUNNER_TEMP/build/release/install-root/valentina\"
          profile:qt6
          project.enableConan:true
          project.conanWithCrashReporting:${{ env.WITH_CRASH_REPORTING }}
          project.conanWithXerces:true
          project.conanProfiles:share/ci/conan/profiles/windows
          modules.buildconfig.enablePCH:true
          modules.windeployqt.compilerRuntime:true
          modules.windeployqt.noCompilerRuntime:false" >> $GITHUB_ENV

      - name: Build Valentina
        shell: bash
        run: qbs build ${{ env.COMMON_QBS_ARGS }}

      - name: Tests
        if: env.RUN_TESTS == 'true'
        shell: bash
        run: qbs -p autotest-runner ${{ env.COMMON_QBS_ARGS }}

      - name: Deploy symbols
        if: env.WITH_CRASH_REPORTING == 'True'
        shell: pwsh
        env:
          BUGSPLAT_DATABASE: "valentina"
          SYMBOL_UPLOAD_CLIENT_ID: ${{ secrets.SYMBOL_UPLOAD_CLIENT_ID }}
          SYMBOL_UPLOAD_CLIENT_SECRET: ${{ secrets.SYMBOL_UPLOAD_CLIENT_SECRET }}
        run: |
          # Download symbol-upload
          Invoke-WebRequest -Uri "https://app.bugsplat.com/download/symbol-upload-windows.exe" `
            -OutFile "${{ runner.temp }}\symbol-upload-windows.exe"

          # Build version components
          $qtVersion = (& "$env:QT_ROOT_DIR\bin\qmake.exe" -query QT_VERSION) `
            -replace '(\d+)\.(\d+).*', 'Qt_$1_$2'
          $shortSha  = git log --pretty=format:%h -n 1

          # Add symbol-upload to PATH for this step
          $env:PATH = "${{ runner.temp }};$env:PATH"

          # Rename so the script can call it as 'symbol-upload'
          Rename-Item "${{ runner.temp }}\symbol-upload-windows.exe" "symbol-upload.exe"

          python ./scripts/upload_symbols.py `
            --build-dir   "${{ runner.temp }}\build\release\install-root\valentina" `
            --app-version $env:VALENTINA_VERSION `
            --git-hash    "g$shortSha" `
            --qt-version  $qtVersion

      - name: Create installer
        if: github.event_name != 'pull_request' && env.DEPLOY == 'true'
        shell: bash
        run: qbs build -p ValentinaSetup ${{ env.COMMON_QBS_ARGS }}

      - name: Commit hash
        id: commit
        if: github.event_name != 'pull_request' && env.DEPLOY == 'true'
        uses: prompt/actions-commit-hash@v3

      - name: Deploy
        if: github.event_name != 'pull_request' && env.DEPLOY == 'true'
        shell: pwsh
        env:
          VALENTINA_BUILD_FOLDER: ${{ runner.temp }}\build
          APPVEYOR_BUILD_FOLDER: ${{ env.SOURCE_DIR }}
          APPVEYOR_REPO_BRANCH: ${{ github.base_ref || github.ref_name }}
          APPVEYOR_REPO_COMMIT: ${{ steps.commit.outputs.hash }}
          PYTHON: ${{ env.Python3_ROOT_DIR }}
          TARGET_PLATFORM: "Windows10+"
          ARCH: x64
          COMPILER: msvc
        run: ./scripts/appveyor-deploy.ps1
  legacy_build:
    name: Windows Qt ${{ matrix.qt.install }} (GCC ${{ matrix.qt.build_arch }})
    runs-on: windows-latest

    strategy:
      matrix:
        qt:
          - install: 5.15.2
            label: Qt5_15
            compiler: mingw
            arch: 'win32_mingw81'
            tools: 'tools_mingw81,qt.tools.win32_mingw810'
            build_arch: 'x86'
            deploy: 'true'

    env:
      DEPLOY: ${{ matrix.qt.deploy }}
      RUN_TESTS: 'true'
      QT_VERSION: ${{ matrix.qt.label }}
      COMPILER: ${{ matrix.qt.compiler }}
      ARCH: ${{ matrix.qt.build_arch }}
      TARGET_PLATFORM: "Windows7+"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Fetch tags
        run: git fetch --prune --unshallow --tags

      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          architecture: "x64"
          cache: 'pip'
          cache-dependency-path: 'share/ci/requirements-ci.txt'

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version:      ${{ matrix.qt.install }}
          host:         'windows'
          target:       'desktop'
          arch:         ${{ matrix.qt.arch }}
          dir:          ${{ runner.temp }}
          tools:        ${{ matrix.qt.tools }}
          cache:        true
          setup-python: false

      - name: Install Python dependencies
        run: |
          python3 --version
          python3 -m pip install --upgrade setuptools
          python3 -m pip install -r share/ci/requirements-ci.txt

      - name: Cache Chocolatey
        uses: actions/cache@v4
        with:
          path: C:\Users\runneradmin\AppData\Local\Temp\chocolatey
          # This caches the cache, no need to make sure that this is invalidated
          # chocolatey will do that for us.
          key: chocolatey-cache

      - name: Install Chocolatey dependencies
        run: |
          choco install qbs -y --version=${{ env.QBS_VERSION }}
          choco install innosetup -y --version=${{ env.INNOSETUP_VERSION }}
          qbs --version

      - name: Before build
        run: |
          git fetch --tags
          qbs-setup-toolchains --detect
          qbs-setup-qt %QT_ROOT_DIR%\bin\qmake.exe qt5
          qbs-config defaultProfile qt5
          qbs-setup-toolchains.exe --type ${{ env.COMPILER }} ${{ env.IQTA_TOOLS }}\mingw810_32\bin\g++.exe ${{ env.COMPILER }}
          qbs-config.exe profiles.qt5.baseProfile ${{ env.COMPILER }}
          qbs-config --list profiles

      - name: Set up common Qbs args
        shell: bash
        run: >
          echo "COMMON_QBS_ARGS=
          -f valentina.qbs
          -d \"$RUNNER_TEMP/build\"
          config:release
          qbs.installRoot:\"$RUNNER_TEMP/build/release/install-root/valentina\"
          profile:qt5
          modules.buildconfig.enablePCH:true
          modules.windeployqt.compilerRuntime:true
          modules.windeployqt.noCompilerRuntime:false" >> $GITHUB_ENV

      - name: Build Valentina
        shell: bash
        run: qbs build ${{ env.COMMON_QBS_ARGS }}
  
      - name: Tests
        if: env.RUN_TESTS == 'true'
        shell: bash
        run: qbs -p autotest-runner ${{ env.COMMON_QBS_ARGS }}

      - name: Create installer
        if: github.event_name != 'pull_request' && env.DEPLOY == 'true'
        shell: bash
        run: qbs build -p ValentinaSetup ${{ env.COMMON_QBS_ARGS }}

      - name: Commit hash
        id: commit
        if: github.event_name != 'pull_request' && env.DEPLOY == 'true'
        uses: prompt/actions-commit-hash@v3

      - name: Deploy
        if: github.event_name != 'pull_request' && env.DEPLOY == 'true'
        shell: pwsh
        env:
          VALENTINA_BUILD_FOLDER: ${{ runner.temp }}\build
          APPVEYOR_BUILD_FOLDER: ${{ env.SOURCE_DIR }}
          APPVEYOR_REPO_BRANCH: ${{ github.base_ref || github.ref_name }}
          APPVEYOR_REPO_COMMIT: ${{ steps.commit.outputs.hash }}
          PYTHON: ${{ env.Python3_ROOT_DIR }}
        run: ./scripts/appveyor-deploy.ps1

